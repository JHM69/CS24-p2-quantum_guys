package com.quantum_guys.dncc_eco_sync.ui.activities.volunteer;import static com.quantum_guys.dncc_eco_sync.ui.activities.MainActivity.userId;import android.annotation.SuppressLint;import android.graphics.Color;import android.os.Bundle;import android.util.Log;import android.view.LayoutInflater;import android.view.View;import android.view.ViewGroup;import android.widget.AdapterView;import android.widget.ArrayAdapter;import android.widget.Spinner;import android.widget.TextView;import android.widget.Toast;import androidx.annotation.NonNull;import androidx.annotation.Nullable;import androidx.constraintlayout.widget.ConstraintLayout;import androidx.fragment.app.Fragment;import androidx.paging.PagedList;import androidx.recyclerview.widget.DefaultItemAnimator;import androidx.recyclerview.widget.DividerItemDecoration;import androidx.recyclerview.widget.LinearLayoutManager;import androidx.recyclerview.widget.RecyclerView;import androidx.swiperefreshlayout.widget.SwipeRefreshLayout;import com.bumptech.glide.Glide;import com.bumptech.glide.request.RequestOptions;import com.firebase.ui.firestore.paging.FirestorePagingAdapter;import com.firebase.ui.firestore.paging.FirestorePagingOptions;import com.firebase.ui.firestore.paging.LoadingState;import com.github.marlonlom.utilities.timeago.TimeAgo;import com.google.firebase.firestore.FirebaseFirestore;import com.google.firebase.firestore.Query;import com.quantum_guys.dncc_eco_sync.R;import com.quantum_guys.dncc_eco_sync.models.Users;import java.util.Arrays;import java.util.List;import de.hdodenhof.circleimageview.CircleImageView;/** * Created by jhm69 */public class Ranking extends Fragment {    String institu, area, sub, typ;    String ward = "All";    private FirebaseFirestore firestore;    long t;    private RecyclerView mRecyclerView;    private SwipeRefreshLayout refreshLayout;    @Nullable    @Override    public View onCreateView(LayoutInflater inflater, @Nullable ViewGroup container, @Nullable Bundle savedInstanceState) {        return inflater.inflate(R.layout.ranking, container, false);    }    @Override    public void onViewCreated(@NonNull View view, @Nullable Bundle savedInstanceState) {        super.onViewCreated(view, savedInstanceState);        firestore = FirebaseFirestore.getInstance();        mRecyclerView = view.findViewById(R.id.messageList);        refreshLayout = view.findViewById(R.id.refreshLayout);        List<String> wards = Arrays.asList(getResources().getStringArray(R.array.wards));        Spinner spinner_wards = view.findViewById(R.id.spinner_class_level);        ArrayAdapter<String> spinnerArrayAdapter_type = new ArrayAdapter<>(requireActivity(),                android.R.layout.simple_spinner_dropdown_item, wards);        spinner_wards.setAdapter(spinnerArrayAdapter_type);        spinner_wards.setOnItemSelectedListener(new AdapterView.OnItemSelectedListener() {            public void onItemSelected(AdapterView<?> parent, View view, int position, long id) {                ward = wards.get(position);                setupAdapter(ward);            }            public void onNothingSelected(AdapterView<?> parent) {                ward = "All";            }        });        mRecyclerView.setItemAnimator(new DefaultItemAnimator());        mRecyclerView.setLayoutManager(new LinearLayoutManager(view.getContext()));        mRecyclerView.setHasFixedSize(true);        mRecyclerView.addItemDecoration(new DividerItemDecoration(view.getContext(), DividerItemDecoration.VERTICAL));        refreshLayout.setOnRefreshListener(() -> setupAdapter(ward));    }    private void setupAdapter(String ward) {        PagedList.Config config = new PagedList.Config.Builder()                .setEnablePlaceholders(false)                .setPrefetchDistance(5)                .setPageSize(10)                .build();        Query mQuery = firestore.collection("Users")                .orderBy("score", Query.Direction.DESCENDING);        if (!ward.equals("All")) {            mQuery = mQuery.whereEqualTo("ward", ward);        }        FirestorePagingOptions<Users> options = new FirestorePagingOptions.Builder<Users>()                .setLifecycleOwner(this)                .setQuery(mQuery, config, Users.class)                .build();        FirestorePagingAdapter<Users, ViewHolder> mAdapter = new FirestorePagingAdapter<Users, ViewHolder>(options) {            @NonNull            @Override            public ViewHolder onCreateViewHolder(@NonNull ViewGroup parent, int viewType) {                View view = getLayoutInflater().inflate(R.layout.item_quiz_profile, parent, false);                return new ViewHolder(view);            }            @SuppressLint({"SetTextI18n", "UseCompatLoadingForColorStateLists"})            @Override            protected void onBindViewHolder(@NonNull ViewHolder holder, int position, @NonNull Users user) {                requireView().findViewById(R.id.default_item).setVisibility(View.GONE);                holder.name.setText(user.getName());//                if(user.getDept().length() > 1 && user.getInstitute().length() > 1) {//                    holder.institute.setText(user.getDept() + ", " + user.getInstitute());//                }else if (user.getDept().length()<2) {//                    holder.institute.setText(user.getInstitute());//                } else if (user.getInstitute().length()<2) {//                    holder.institute.setText(user.getDept());//                }//                if(user.getDept().length()<1 && user.getInstitute().length() < 1){//                    holder.institute.setVisibility(View.GONE);//                }                int score = (int) user.getScore();                holder.rank.setVisibility(View.VISIBLE);                holder.level.setText(String.valueOf(score));                if (user.getId().equals(userId)) {                    holder.name.setText("You");                    holder.back.setBackgroundColor(Color.parseColor("#DCDCFB"));                }else{                    holder.back.setBackgroundColor(Color.parseColor("#ffffff"));                }                holder.time.setText(getTimeText(user.getLastTimestamp()));                holder.rank.setText(String.valueOf(position + 1));                Glide.with(requireContext())                        .setDefaultRequestOptions(new RequestOptions().placeholder(R.drawable.logo_round))                        .load(user.getImage())                        .into(holder.image);                holder.mView.setOnClickListener(view -> FriendProfile.startActivity(getContext(), user.getId()));            }            @Override            protected void onError(@NonNull Exception e) {                super.onError(e);                Log.e("MainActivity", e.getMessage());            }            @Override            protected void onLoadingStateChanged(@NonNull LoadingState state) {                switch (state) {                    case LOADING_INITIAL:                    case LOADING_MORE:                        refreshLayout.setRefreshing(true);                        break;                    case LOADED:                        if (getItemCount() == 0) {                            requireView().findViewById(R.id.default_item).setVisibility(View.VISIBLE);                        }                        refreshLayout.setRefreshing(false);                        break;                    case ERROR:                        Toast.makeText(                                getActivity(),                                "Error Occurred!",                                Toast.LENGTH_SHORT                        ).show();                        refreshLayout.setRefreshing(false);                        break;                    case FINISHED:                        refreshLayout.setRefreshing(false);                        break;                }            }        };        mRecyclerView.setAdapter(mAdapter);    }    private String getTimeText(long lastTimestamp) {        String time = TimeAgo.using(lastTimestamp);        time = time.replaceAll("just now", "now")                .replaceAll(" minutes", "m")                .replaceAll(" minute", "1m")                .replaceAll("about", "")                .replaceAll(" hours", "h")                .replaceAll(" hour", "1h")                .replaceAll(" an", "")                .replaceAll("a ", "1 ")                .replaceAll(" ago", "")                .replaceAll("yesterday", "1d")                .replaceAll(" days", "d")                .replaceAll(" day", "1d");        return time;    }    public static class ViewHolder extends RecyclerView.ViewHolder {        final View mView;        final CircleImageView image;        final TextView name;        final TextView institute;        final TextView level;        final TextView rank, time;        final ConstraintLayout back;        public ViewHolder(View itemView) {            super(itemView);            mView = itemView;            image = mView.findViewById(R.id.image);            name = mView.findViewById(R.id.name);            institute = mView.findViewById(R.id.institute);            level = mView.findViewById(R.id.levelCount);            rank = mView.findViewById(R.id.rank);            back = mView.findViewById(R.id.back);            time = mView.findViewById(R.id.textView4);        }    }    String getType(long t) {        if (t == 0) return "bsc";        if (t == 1) return "hsc";        if (t == 2) return "ssc";        else return "bsc";    }}